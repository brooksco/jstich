window.wp=window.wp||{},function(e){var t,n,r,i,s,o,u;u=wp.media=function(e){var t,n=u.view.MediaFrame;if(n)return e=_.defaults(e||{},{frame:"select"}),"select"===e.frame&&n.Select?t=new n.Select(e):"post"===e.frame&&n.Post?t=new n.Post(e):"image"===e.frame&&n.ImageDetails?t=new n.ImageDetails(e):"audio"===e.frame&&n.AudioDetails?t=new n.AudioDetails(e):"video"===e.frame&&n.VideoDetails&&(t=new n.VideoDetails(e)),delete e.frame,u.frame=t,t},_.extend(u,{model:{},view:{},controller:{},frames:{}}),o=u.model.l10n="undefined"==typeof _wpMediaModelsL10n?{}:_wpMediaModelsL10n,u.model.settings=o.settings||{},delete o.settings,s=function(e,t,n,r){return _.isEqual(e,t)?n===r?0:n>r?-1:1:e>t?-1:1},_.extend(u,{template:wp.template,post:wp.ajax.post,ajax:wp.ajax.send,fit:function(e){var t,n=e.width,r=e.height,i=e.maxWidth,s=e.maxHeight;return _.isUndefined(i)||_.isUndefined(s)?_.isUndefined(s)?t="width":_.isUndefined(i)&&r>s&&(t="height"):t=n/r>i/s?"width":"height","width"===t&&n>i?{width:i,height:Math.round(i*r/n)}:"height"===t&&r>s?{width:Math.round(s*n/r),height:s}:{width:n,height:r}},truncate:function(e,t,n){return t=t||30,n=n||"&hellip;",e.length<=t?e:e.substr(0,t/2)+n+e.substr(-1*t/2)}}),u.attachment=function(e){return t.get(e)},t=u.model.Attachment=Backbone.Model.extend({sync:function(t,n,r){return _.isUndefined(this.id)?e.Deferred().rejectWith(this).promise():"read"===t?(r=r||{},r.context=this,r.data=_.extend(r.data||{},{action:"get-attachment",id:this.id}),u.ajax(r)):"update"===t?this.get("nonces")&&this.get("nonces").update?(r=r||{},r.context=this,r.data=_.extend(r.data||{},{action:"save-attachment",id:this.id,nonce:this.get("nonces").update,post_id:u.model.settings.post.id}),n.hasChanged()&&(r.data.changes={},_.each(n.changed,function(e,t){r.data.changes[t]=this.get(t)},this)),u.ajax(r)):e.Deferred().rejectWith(this).promise():"delete"===t?(r=r||{},r.wait||(this.destroyed=!0),r.context=this,r.data=_.extend(r.data||{},{action:"delete-post",id:this.id,_wpnonce:this.get("nonces")["delete"]}),u.ajax(r).done(function(){this.destroyed=!0}).fail(function(){this.destroyed=!1})):Backbone.Model.prototype.sync.apply(this,arguments)},parse:function(e){return e?(e.date=new Date(e.date),e.modified=new Date(e.modified),e):e},saveCompat:function(t,n){var r=this;return this.get("nonces")&&this.get("nonces").update?u.post("save-attachment-compat",_.defaults({id:this.id,nonce:this.get("nonces").update,post_id:u.model.settings.post.id},t)).done(function(e,t,i){r.set(r.parse(e,i),n)}):e.Deferred().rejectWith(this).promise()}},{create:function(e){return n.all.push(e)},get:_.memoize(function(e,t){return n.all.push(t||{id:e})})}),i=u.model.PostImage=Backbone.Model.extend({initialize:function(n){this.attachment=!1,n.attachment_id&&(this.attachment=t.get(n.attachment_id),this.attachment.get("url")?(this.dfd=e.Deferred(),this.dfd.resolve()):this.dfd=this.attachment.fetch(),this.bindAttachmentListeners()),this.on("change:link",this.updateLinkUrl,this),this.on("change:size",this.updateSize,this),this.setLinkTypeFromUrl(),this.setAspectRatio(),this.set("originalUrl",n.url)},bindAttachmentListeners:function(){this.listenTo(this.attachment,"sync",this.setLinkTypeFromUrl),this.listenTo(this.attachment,"sync",this.setAspectRatio),this.listenTo(this.attachment,"change",this.updateSize)},changeAttachment:function(e,t){this.stopListening(this.attachment),this.attachment=e,this.bindAttachmentListeners(),this.set("attachment_id",this.attachment.get("id")),this.set("caption",this.attachment.get("caption")),this.set("alt",this.attachment.get("alt")),this.set("size",t.get("size")),this.set("align",t.get("align")),this.set("link",t.get("link")),this.updateLinkUrl(),this.updateSize()},setLinkTypeFromUrl:function(){var e,t=this.get("linkUrl");return t?(e="custom",this.attachment?this.attachment.get("url")===t?e="file":this.attachment.get("link")===t&&(e="post"):this.get("url")===t&&(e="file"),void this.set("link",e)):void this.set("link","none")},updateLinkUrl:function(){var e,t=this.get("link");switch(t){case"file":e=this.attachment?this.attachment.get("url"):this.get("url"),this.set("linkUrl",e);break;case"post":this.set("linkUrl",this.attachment.get("link"));break;case"none":this.set("linkUrl","")}},updateSize:function(){var e;if(this.attachment){if("custom"===this.get("size"))return this.set("width",this.get("customWidth")),this.set("height",this.get("customHeight")),void this.set("url",this.get("originalUrl"));e=this.attachment.get("sizes")[this.get("size")],e&&(this.set("url",e.url),this.set("width",e.width),this.set("height",e.height))}},setAspectRatio:function(){var e;return this.attachment&&this.attachment.get("sizes")&&(e=this.attachment.get("sizes").full)?void this.set("aspectRatio",e.width/e.height):void this.set("aspectRatio",this.get("customWidth")/this.get("customHeight"))}}),n=u.model.Attachments=Backbone.Collection.extend({model:t,initialize:function(e,t){t=t||{},this.props=new Backbone.Model,this.filters=t.filters||{},this.props.on("change",this._changeFilteredProps,this),this.props.on("change:order",this._changeOrder,this),this.props.on("change:orderby",this._changeOrderby,this),this.props.on("change:query",this._changeQuery,this),this.props.set(_.defaults(t.props||{})),t.observe&&this.observe(t.observe)},_changeOrder:function(){this.comparator&&this.sort()},_changeOrderby:function(e,t){this.comparator&&this.comparator!==n.comparator||(t&&"post__in"!==t?this.comparator=n.comparator:delete this.comparator)},_changeQuery:function(e,t){t?(this.props.on("change",this._requery,this),this._requery()):this.props.off("change",this._requery,this)},_changeFilteredProps:function(e){if(!this.props.get("query")){var t=_.chain(e.changed).map(function(t,r){var i=n.filters[r],s=e.get(r);if(i){if(s&&!this.filters[r])this.filters[r]=i;else{if(s||this.filters[r]!==i)return;delete this.filters[r]}return!0}},this).any().value();t&&(this._source||(this._source=new n(this.models)),this.reset(this._source.filter(this.validator,this)))}},validateDestroyed:!1,validator:function(e){return!this.validateDestroyed&&e.destroyed?!1:_.all(this.filters,function(t){return!!t.call(this,e)},this)},validate:function(e,t){var n=this.validator(e),r=!!this.get(e.cid);return!n&&r?this.remove(e,t):n&&!r&&this.add(e,t),this},validateAll:function(e,t){return t=t||{},_.each(e.models,function(e){this.validate(e,{silent:!0})},this),t.silent||this.trigger("reset",this,t),this},observe:function(e){return this.observers=this.observers||[],this.observers.push(e),e.on("add change remove",this._validateHandler,this),e.on("reset",this._validateAllHandler,this),this.validateAll(e),this},unobserve:function(e){return e?(e.off(null,null,this),this.observers=_.without(this.observers,e)):(_.each(this.observers,function(e){e.off(null,null,this)},this),delete this.observers),this},_validateHandler:function(e,t,n){return n=t===this.mirroring?n:{silent:n&&n.silent},this.validate(e,n)},_validateAllHandler:function(e,t){return this.validateAll(e,t)},mirror:function(e){return this.mirroring&&this.mirroring===e?this:(this.unmirror(),this.mirroring=e,this.reset([],{silent:!0}),this.observe(e),this)},unmirror:function(){this.mirroring&&(this.unobserve(this.mirroring),delete this.mirroring)},more:function(t){var n=e.Deferred(),r=this.mirroring,i=this;return r&&r.more?(r.more(t).done(function(){this===i.mirroring&&n.resolveWith(this)}),n.promise()):n.resolveWith(this).promise()},hasMore:function(){return this.mirroring?this.mirroring.hasMore():!1},parse:function(e,n){return _.isArray(e)||(e=[e]),_.map(e,function(e){var r,i,s;return e instanceof Backbone.Model?(r=e.get("id"),e=e.attributes):r=e.id,i=t.get(r),s=i.parse(e,n),_.isEqual(i.attributes,s)||i.set(s),i})},_requery:function(){this.props.get("query")&&this.mirror(r.get(this.props.toJSON()))},saveMenuOrder:function(){if("menuOrder"===this.props.get("orderby")){var e=this.chain().filter(function(e){return!_.isUndefined(e.id)}).map(function(e,t){return t+=1,e.set("menuOrder",t),[e.id,t]}).object().value();if(!_.isEmpty(e))return u.post("save-attachment-order",{nonce:u.model.settings.post.nonce,post_id:u.model.settings.post.id,attachments:e})}}},{comparator:function(e,t,n){var r=this.props.get("orderby"),i=this.props.get("order")||"DESC",o=e.cid,u=t.cid;return e=e.get(r),t=t.get(r),("date"===r||"modified"===r)&&(e=e||new Date,t=t||new Date),n&&n.ties&&(o=u=null),"DESC"===i?s(e,t,o,u):s(t,e,u,o)},filters:{search:function(e){return this.props.get("search")?_.any(["title","filename","description","caption","name"],function(t){var n=e.get(t);return n&&-1!==n.search(this.props.get("search"))},this):!0},type:function(e){var t=this.props.get("type");return!t||-1!==t.indexOf(e.get("type"))},uploadedTo:function(e){var t=this.props.get("uploadedTo");return _.isUndefined(t)?!0:t===e.get("uploadedTo")}}}),n.all=new n,u.query=function(e){return new n(null,{props:_.extend(_.defaults(e||{},{orderby:"date"}),{query:!0})})},r=u.model.Query=n.extend({initialize:function(e,t){var r;t=t||{},n.prototype.initialize.apply(this,arguments),this.args=t.args,this._hasMore=!0,this.created=new Date,this.filters.order=function(e){var t=this.props.get("orderby"),n=this.props.get("order");return this.comparator?this.length?1!==this.comparator(e,this.last(),{ties:!0}):"DESC"!==n||"date"!==t&&"modified"!==t?"ASC"===n&&"menuOrder"===t?0===e.get(t):!1:e.get(t)>=this.created:!0},r=["s","order","orderby","posts_per_page","post_mime_type","post_parent"],wp.Uploader&&_(this.args).chain().keys().difference(r).isEmpty().value()&&this.observe(wp.Uploader.queue)},hasMore:function(){return this._hasMore},more:function(t){var n=this;return this._more&&"pending"===this._more.state()?this._more:this.hasMore()?(t=t||{},t.remove=!1,this._more=this.fetch(t).done(function(e){(_.isEmpty(e)||-1===this.args.posts_per_page||e.length<this.args.posts_per_page)&&(n._hasMore=!1)})):e.Deferred().resolveWith(this).promise()},sync:function(e,t,r){var i,s;return"read"===e?(r=r||{},r.context=this,r.data=_.extend(r.data||{},{action:"query-attachments",post_id:u.model.settings.post.id}),i=_.clone(this.args),-1!==i.posts_per_page&&(i.paged=Math.floor(this.length/i.posts_per_page)+1),r.data.query=i,u.ajax(r)):(s=n.prototype.sync?n.prototype:Backbone,s.sync.apply(this,arguments))}},{defaultProps:{orderby:"date",order:"DESC"},defaultArgs:{posts_per_page:40},orderby:{allowed:["name","author","date","title","modified","uploadedTo","id","post__in","menuOrder"],valuemap:{id:"ID",uploadedTo:"parent",menuOrder:"menu_order ID"}},propmap:{search:"s",type:"post_mime_type",perPage:"posts_per_page",menuOrder:"menu_order",uploadedTo:"post_parent"},get:function(){var e=[];return function(t,n){var i,s={},o=r.orderby,u=r.defaultProps;return delete t.query,_.defaults(t,u),t.order=t.order.toUpperCase(),"DESC"!==t.order&&"ASC"!==t.order&&(t.order=u.order.toUpperCase()),_.contains(o.allowed,t.orderby)||(t.orderby=u.orderby),_.each(t,function(e,t){_.isNull(e)||(s[r.propmap[t]||t]=e)}),_.defaults(s,r.defaultArgs),s.orderby=o.valuemap[t.orderby]||t.orderby,i=_.find(e,function(e){return _.isEqual(e.args,s)}),i||(i=new r([],_.extend(n||{},{props:t,args:s})),e.push(i)),i}}()}),u.model.Selection=n.extend({initialize:function(e,t){n.prototype.initialize.apply(this,arguments),this.multiple=t&&t.multiple,this.on("add remove reset",_.bind(this.single,this,!1))},add:function(e,t){return this.multiple||this.remove(this.models),n.prototype.add.call(this,e,t)},single:function(e){var t=this._single;return e&&(this._single=e),this._single&&!this.get(this._single.cid)&&delete this._single,this._single=this._single||this.last(),this._single!==t&&(t&&(t.trigger("selection:unsingle",t,this),this.get(t.cid)||this.trigger("selection:unsingle",t,this)),this._single&&this._single.trigger("selection:single",this._single,this)),this._single}}),e(window).on("unload",function(){window.wp=null})}(jQuery);