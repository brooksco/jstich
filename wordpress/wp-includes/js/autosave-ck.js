/* global tinymce, wpCookies, autosaveL10n, switchEditors */// Back-compat
window.autosave=function(){return!0};(function(e,t){function n(){function s(t){var n,i,s,o=(new Date).getTime(),u=[],a=typeof tinymce!="undefined"&&tinymce.get("content");if(a&&!a.isHidden()&&o-3e3>r){a.save();r=o}s={post_id:e("#post_ID").val()||0,post_type:e("#post_type").val()||"",post_author:e("#post_author").val()||"",post_title:e("#title").val()||"",content:e("#content").val()||"",excerpt:e("#excerpt").val()||""};if(t==="local")return s;e('input[id^="in-category-"]:checked').each(function(){u.push(this.value)});s.catslist=u.join(",");if(n=e("#post_name").val())s.post_name=n;if(i=e("#parent_id").val())s.parent_id=i;e("#comment_status").prop("checked")&&(s.comment_status="open");e("#ping_status").prop("checked")&&(s.ping_status="open");e("#auto_draft").val()==="1"&&(s.auto_draft="1");return s}function o(t){return typeof t=="object"?(t.post_title||"")+"::"+(t.content||"")+"::"+(t.excerpt||""):(e("#title").val()||"")+"::"+(e("#content").val()||"")+"::"+(e("#excerpt").val()||"")}function u(){i.trigger("autosave-disable-buttons");setTimeout(a,5e3)}function a(){i.trigger("autosave-enable-buttons")}function f(){function d(){var e=Math.random().toString(),n=!1;try{t.sessionStorage.setItem("wp-test",e);n=t.sessionStorage.getItem("wp-test")===e;t.sessionStorage.removeItem("wp-test")}catch(r){}l=n;return n}function v(){var e=!1;if(l&&a){e=sessionStorage.getItem("wp-autosave-"+a);e?e=JSON.parse(e):e={}}return e}function m(e){var t;if(l&&a){t="wp-autosave-"+a;sessionStorage.setItem(t,JSON.stringify(e));return sessionStorage.getItem(t)!==null}return!1}function g(){var e=v();return!e||!f?!1:e["post_"+f]||!1}function y(e){var t=v();if(!t||!f)return!1;if(e)t["post_"+f]=e;else{if(!t.hasOwnProperty("post_"+f))return!1;delete t["post_"+f]}return m(t)}function b(){p=!0}function w(){p=!1}function E(t){var r,i,u=!1;if(p)return!1;if(t){r=g()||{};e.extend(r,t)}else r=s("local");i=o(r);typeof h=="undefined"&&(h=n);if(i===h)return!1;r.save_time=(new Date).getTime();r.status=e("#post_status").val()||"";u=y(r);u&&(h=i);return u}function S(){f=e("#post_ID").val()||0;e("#wp-content-wrap").hasClass("tmce-active")?i.on("tinymce-editor-init.autosave",function(){t.setTimeout(function(){T()},1500)}):T();c=t.setInterval(E,15e3);e("form#post").on("submit.autosave-local",function(){var t=typeof tinymce!="undefined"&&tinymce.get("content"),n=e("#post_ID").val()||0;t&&!t.isHidden()?t.on("submit",function(){E({post_title:e("#title").val()||"",content:e("#content").val()||"",excerpt:e("#excerpt").val()||""})}):E({post_title:e("#title").val()||"",content:e("#content").val()||"",excerpt:e("#excerpt").val()||""});wpCookies.set("wp-saving-post-"+n,"check")})}function x(e,t){function n(e){return e.toString().replace(/[\x20\t\r\n\f]+/g,"")}return n(e||"")===n(t||"")}function T(){var t,n,i,s,o=g(),a=wpCookies.get("wp-saving-post-"+f);if(!o)return;if(a){wpCookies.remove("wp-saving-post-"+f);if(a==="saved"){y(!1);return}}if(e("#has-newer-autosave").length)return;t=e("#content").val()||"";n=e("#title").val()||"";i=e("#excerpt").val()||"";if(a!=="check"&&x(t,o.content)&&x(n,o.post_title)&&x(i,o.excerpt))return;r=o;u={content:t,post_title:n,excerpt:i};s=e("#local-storage-notice");e(".wrap h2").first().after(s.addClass("updated").show());s.on("click.autosave-local",function(t){var n=e(t.target);if(n.hasClass("restore-backup")){N(r);n.parent().hide();e(this).find("p.undo-restore").show()}else if(n.hasClass("undo-restore-backup")){N(u);n.parent().hide();e(this).find("p.local-restore").show()}t.preventDefault()})}function N(t){var n;if(t){h=o(t);e("#title").val()!==t.post_title&&e("#title").focus().val(t.post_title||"");e("#excerpt").val(t.excerpt||"");n=typeof tinymce!="undefined"&&tinymce.get("content");if(n&&!n.isHidden()&&typeof switchEditors!="undefined"){n.undoManager.add();n.setContent(t.content?switchEditors.wpautop(t.content):"")}else{e("#content-html").click();e("#content").val(t.content)}return!0}return!1}var r,u,a,f,l,c,h,p=!1;a=typeof t.autosaveL10n!="undefined"&&t.autosaveL10n.blog_id;if(!d())return;if(!a||!e("#content").length&&!e("#excerpt").length)return;i.ready(S);return{hasStorage:l,getSavedPostData:g,save:E,suspend:b,resume:w}}function l(){function d(){r=!0;t.clearTimeout(f);f=t.setTimeout(function(){r=!1},1e4)}function v(){p=!0}function m(){p=!1}function g(t){E();r=!1;c=l;l="";i.trigger("after-autosave",[t]);a();t.success&&e("#auto_draft").val("")}function y(){h=0;wp.heartbeat.connectNow()}function b(){return o()!==n}function w(){var a,f;if(p||r||!t.autosave())return!1;if((new Date).getTime()<h)return!1;a=s();f=o(a);typeof c=="undefined"&&(c=n);if(f===c)return!1;l=f;d();u();i.trigger("wpcountwords",[a.content]).trigger("before-autosave",[a]);a._wpnonce=e("#_wpnonce").val()||"";return a}function E(){h=(new Date).getTime()+autosaveL10n.autosaveInterval*1e3||6e4}var r,f,l,c,h=0,p=!1;i.on("heartbeat-send.autosave",function(e,t){var n=w();n&&(t.wp_autosave=n)}).on("heartbeat-tick.autosave",function(e,t){t.wp_autosave&&g(t.wp_autosave)}).on("heartbeat-connection-lost.autosave",function(t,n,r){if("timeout"===n||603===r){var i=e("#lost-connection-notice");wp.autosave.local.hasStorage||i.find(".hide-if-no-sessionstorage").hide();i.show();u()}}).on("heartbeat-connection-restored.autosave",function(){e("#lost-connection-notice").hide();a()}).ready(function(){E()});return{tempBlockSave:d,triggerSave:y,postChanged:b,suspend:v,resume:m}}var n,r=0,i=e(document);i.on("tinymce-editor-init.autosave",function(e,r){r.id==="content"&&t.setTimeout(function(){r.save();n=o()},1e3)}).ready(function(){n=o()});return{getPostData:s,getCompareString:o,disableButtons:u,enableButtons:a,local:f(),server:l()}}t.wp=t.wp||{};t.wp.autosave=n()})(jQuery,window);