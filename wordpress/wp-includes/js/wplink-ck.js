/* global ajaxurl, tinymce, wpLinkL10n, setUserSetting, wpActiveEditor */var wpLink;(function(e){var t={},n={},r,i,s,o;wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",init:function(){t.wrap=e("#wp-link-wrap");t.dialog=e("#wp-link");t.backdrop=e("#wp-link-backdrop");t.submit=e("#wp-link-submit");t.close=e("#wp-link-close");t.url=e("#url-field");t.nonce=e("#_ajax_linking_nonce");t.title=e("#link-title-field");t.openInNewTab=e("#link-target-checkbox");t.search=e("#search-field");n.search=new s(e("#search-results"));n.recent=new s(e("#most-recent-results"));n.elements=t.dialog.find(".query-results");t.dialog.keydown(wpLink.keydown);t.dialog.keyup(wpLink.keyup);t.submit.click(function(e){e.preventDefault();wpLink.update()});t.close.add(t.backdrop).add("#wp-link-cancel a").click(function(e){e.preventDefault();wpLink.close()});e("#wp-link-search-toggle").click(wpLink.toggleInternalLinking);n.elements.on("river-select",wpLink.updateFields);t.search.keyup(function(){var e=this;window.clearTimeout(i);i=window.setTimeout(function(){wpLink.searchInternalLinks.call(e)},500)})},open:function(n){var i;wpLink.range=null;n&&(window.wpActiveEditor=n);if(!window.wpActiveEditor)return;this.textarea=e("#"+window.wpActiveEditor).get(0);if(typeof tinymce!="undefined"){i=tinymce.get(wpActiveEditor);i&&!i.isHidden()?r=i:r=null;r&&tinymce.isIE&&(r.windowManager.bookmark=r.selection.getBookmark())}if(!wpLink.isMCE()&&document.selection){this.textarea.focus();this.range=document.selection.createRange()}t.wrap.show();t.backdrop.show();wpLink.refresh()},isMCE:function(){return r&&!r.isHidden()},refresh:function(){n.search.refresh();n.recent.refresh();wpLink.isMCE()?wpLink.mceRefresh():wpLink.setDefaultValues();t.url.focus()[0].select();n.recent.ul.children().length||n.recent.ajax()},mceRefresh:function(){var e;if(e=r.dom.getParent(r.selection.getNode(),"A")){t.url.val(r.dom.getAttrib(e,"href"));t.title.val(r.dom.getAttrib(e,"title"));t.openInNewTab.prop("checked","_blank"===r.dom.getAttrib(e,"target"));t.submit.val(wpLinkL10n.update)}else wpLink.setDefaultValues()},close:function(){if(!wpLink.isMCE()){wpLink.textarea.focus();if(wpLink.range){wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select()}}else r.focus();t.backdrop.hide();t.wrap.hide()},getAttrs:function(){return{href:t.url.val(),title:t.title.val(),target:t.openInNewTab.prop("checked")?"_blank":""}},update:function(){wpLink.isMCE()?wpLink.mceUpdate():wpLink.htmlUpdate()},htmlUpdate:function(){var e,t,n,r,i,s,o,u=wpLink.textarea;if(!u)return;e=wpLink.getAttrs();if(!e.href||e.href=="http://")return;t='<a href="'+e.href+'"';if(e.title){s=e.title.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");t+=' title="'+s+'"'}e.target&&(t+=' target="'+e.target+'"');t+=">";if(document.selection&&wpLink.range){u.focus();wpLink.range.text=t+wpLink.range.text+"</a>";wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select();wpLink.range=null}else if(typeof u.selectionStart!="undefined"){n=u.selectionStart;r=u.selectionEnd;o=u.value.substring(n,r);t=t+o+"</a>";i=n+t.length;n==r&&(i-="</a>".length);u.value=u.value.substring(0,n)+t+u.value.substring(r,u.value.length);u.selectionStart=u.selectionEnd=i}wpLink.close();u.focus()},mceUpdate:function(){var e,t=wpLink.getAttrs();wpLink.close();r.focus();tinymce.isIE&&r.selection.moveToBookmark(r.windowManager.bookmark);e=r.dom.getParent(r.selection.getNode(),"a[href]");if(!t.href||t.href=="http://"){r.execCommand("unlink");return}e?r.dom.setAttribs(e,t):r.execCommand("mceInsertLink",!1,t);r.selection.collapse()},updateFields:function(e,n,r){t.url.val(n.children(".item-permalink").val());t.title.val(n.hasClass("no-title")?"":n.children(".item-title").text());r&&r.type=="click"&&t.url.focus()},setDefaultValues:function(){t.url.val("http://");t.title.val("");t.submit.val(wpLinkL10n.save)},searchInternalLinks:function(){var t=e(this),r,i=t.val();if(i.length>2){n.recent.hide();n.search.show();if(wpLink.lastSearch==i)return;wpLink.lastSearch=i;r=t.parent().find(".spinner").show();n.search.change(i);n.search.ajax(function(){r.hide()})}else{n.search.hide();n.recent.show()}},next:function(){n.search.next();n.recent.next()},prev:function(){n.search.prev();n.recent.prev()},keydown:function(n){var r,i,s=e.ui.keyCode;if(s.ESCAPE===n.keyCode){wpLink.close();n.stopImmediatePropagation()}else if(s.TAB===n.keyCode){i=n.target.id;if(i==="wp-link-submit"&&!n.shiftKey){t.close.focus();n.preventDefault()}else if(i==="wp-link-close"&&n.shiftKey){t.submit.focus();n.preventDefault()}}if(n.keyCode!==s.UP&&n.keyCode!==s.DOWN)return;r=n.keyCode===s.UP?"prev":"next";clearInterval(wpLink.keyInterval);wpLink[r]();wpLink.keyInterval=setInterval(wpLink[r],wpLink.keySensitivity);n.preventDefault()},keyup:function(t){var n=e.ui.keyCode;if(t.which===n.UP||t.which===n.DOWN){clearInterval(wpLink.keyInterval);t.preventDefault()}},delayedCallback:function(e,t){var n,r,i,s;if(!t)return e;setTimeout(function(){if(r)return e.apply(s,i);n=!0},t);return function(){if(n)return e.apply(this,arguments);i=arguments;s=this;r=!0}},toggleInternalLinking:function(){var e=t.wrap.hasClass("search-panel-visible");t.wrap.toggleClass("search-panel-visible",!e);setUserSetting("wplink",e?"0":"1");t[e?"url":"search"].focus()}};s=function(t,n){var r=this;this.element=t;this.ul=t.children("ul");this.contentHeight=t.children("#link-selector-height");this.waiting=t.find(".river-waiting");this.change(n);this.refresh();e("#wp-link .query-results, #wp-link #link-selector").scroll(function(){r.maybeLoad()});t.on("click","li",function(t){r.select(e(this),t)})};e.extend(s.prototype,{refresh:function(){this.deselect();this.visible=this.element.is(":visible")},show:function(){if(!this.visible){this.deselect();this.element.show();this.visible=!0}},hide:function(){this.element.hide();this.visible=!1},select:function(e,t){var n,r,i,s;if(e.hasClass("unselectable")||e==this.selected)return;this.deselect();this.selected=e.addClass("selected");n=e.outerHeight();r=this.element.height();i=e.position().top;s=this.element.scrollTop();i<0?this.element.scrollTop(s+i):i+n>r&&this.element.scrollTop(s+i-r+n);this.element.trigger("river-select",[e,t,this])},deselect:function(){this.selected&&this.selected.removeClass("selected");this.selected=!1},prev:function(){if(!this.visible)return;var e;if(this.selected){e=this.selected.prev("li");e.length&&this.select(e)}},next:function(){if(!this.visible)return;var t=this.selected?this.selected.next("li"):e("li:not(.unselectable):first",this.element);t.length&&this.select(t)},ajax:function(e){var t=this,n=this.query.page==1?0:wpLink.minRiverAJAXDuration,r=wpLink.delayedCallback(function(n,r){t.process(n,r);e&&e(n,r)},n);this.query.ajax(r)},change:function(e){if(this.query&&this._search==e)return;this._search=e;this.query=new o(e);this.element.scrollTop(0)},process:function(t,n){var r="",i=!0,s="",o=n.page==1;t?e.each(t,function(){s=i?"alternate":"";s+=this.title?"":" no-title";r+=s?'<li class="'+s+'">':"<li>";r+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />';r+='<span class="item-title">';r+=this.title?this.title:wpLinkL10n.noTitle;r+='</span><span class="item-info">'+this.info+"</span></li>";i=!i}):o&&(r+='<li class="unselectable"><span class="item-title"><em>'+wpLinkL10n.noMatchesFound+"</em></span></li>");this.ul[o?"html":"append"](r)},maybeLoad:function(){var e=this,t=this.element,n=t.scrollTop()+t.height();if(!this.query.ready()||n<this.contentHeight.height()-wpLink.riverBottomThreshold)return;setTimeout(function(){var n=t.scrollTop(),r=n+t.height();if(!e.query.ready()||r<e.contentHeight.height()-wpLink.riverBottomThreshold)return;e.waiting.show();t.scrollTop(n+e.waiting.outerHeight());e.ajax(function(){e.waiting.hide()})},wpLink.timeToTriggerRiver)}});o=function(e){this.page=1;this.allLoaded=!1;this.querying=!1;this.search=e};e.extend(o.prototype,{ready:function(){return!this.querying&&!this.allLoaded},ajax:function(n){var r=this,i={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:t.nonce.val()};this.search&&(i.search=this.search);this.querying=!0;e.post(ajaxurl,i,function(e){r.page++;r.querying=!1;r.allLoaded=!e;n(e,i)},"json")}});e(document).ready(wpLink.init)})(jQuery);