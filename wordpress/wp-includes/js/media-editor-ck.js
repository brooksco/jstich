/* global getUserSetting, tinymce, QTags, wpActiveEditor */// WordPress, TinyMCE, and Media
// -----------------------------
(function(e,t){var n={};wp.media.coerce=function(e,n){t.isUndefined(e[n])&&!t.isUndefined(this.defaults[n])?e[n]=this.defaults[n]:"true"===e[n]?e[n]=!0:"false"===e[n]&&(e[n]=!1);return e[n]};wp.media.string={props:function(e,n){var r,i,s,o,u,a=wp.media.view.settings.defaultProps;u=function(e){if("image"===e.type&&!e.alt){e.alt=e.caption||e.title||"";e.alt=e.alt.replace(/<\/?[^>]+>/g,"");e.alt=e.alt.replace(/[\r\n]+/g," ")}return e};e=e?t.clone(e):{};n&&n.type&&(e.type=n.type);"image"===e.type&&(e=t.defaults(e||{},{align:a.align||getUserSetting("align","none"),size:a.size||getUserSetting("imgsize","medium"),url:"",classes:[]}));if(!n)return u(e);e.title=e.title||n.title;r=e.link||a.link||getUserSetting("urlbutton","file");"file"===r||"embed"===r?i=n.url:"post"===r?i=n.link:"custom"===r&&(i=e.linkUrl);e.linkUrl=i||"";if("image"===n.type){e.classes.push("wp-image-"+n.id);o=n.sizes;s=o&&o[e.size]?o[e.size]:n;t.extend(e,t.pick(n,"align","caption","alt"),{width:s.width,height:s.height,src:s.url,captionId:"attachment_"+n.id})}else if("video"===n.type||"audio"===n.type)t.extend(e,t.pick(n,"title","type","icon","mime"));else{e.title=e.title||n.filename;e.rel=e.rel||"attachment wp-att-"+n.id}return u(e)},link:function(e,t){var n;e=wp.media.string.props(e,t);n={tag:"a",content:e.title,attrs:{href:e.linkUrl}};e.rel&&(n.attrs.rel=e.rel);return wp.html.string(n)},audio:function(e,t){return wp.media.string._audioVideo("audio",e,t)},video:function(e,t){return wp.media.string._audioVideo("video",e,t)},_audioVideo:function(e,n,r){var i,s,o;n=wp.media.string.props(n,r);if(n.link!=="embed")return wp.media.string.link(n);i={};if("video"===e){r.image&&-1===r.image.src.indexOf(r.icon)&&(i.poster=r.image.src);r.width&&(i.width=r.width);r.height&&(i.height=r.height)}o=r.filename.split(".").pop();if(!t.contains(wp.media.view.settings.embedExts,o))return wp.media.string.link(n);i[o]=r.url;s=wp.shortcode.string({tag:e,attrs:i});return s},image:function(e,n){var r={},i,s,o,u;e=wp.media.string.props(e,n);s=e.classes||[];r.src=t.isUndefined(n)?e.url:n.url;t.extend(r,t.pick(e,"width","height","alt"));e.align&&!e.caption&&s.push("align"+e.align);e.size&&s.push("size-"+e.size);r["class"]=t.compact(s).join(" ");i={tag:"img",attrs:r,single:!0};e.linkUrl&&(i={tag:"a",attrs:{href:e.linkUrl},content:i});u=wp.html.string(i);if(e.caption){o={};r.width&&(o.width=r.width);e.captionId&&(o.id=e.captionId);e.align&&(o.align="align"+e.align);u=wp.shortcode.string({tag:"caption",attrs:o,content:u+" "+e.caption})}return u}};wp.media.collection=function(e){var n={};return t.extend(e,{coerce:wp.media.coerce,attachments:function(e){var r=e.string(),i=n[r],s,o,u,a,f=this;delete n[r];if(i)return i;s=t.defaults(e.attrs.named,this.defaults);o=t.pick(s,"orderby","order");o.type=this.type;o.perPage=-1;undefined!==s.orderby&&(s._orderByField=s.orderby);"rand"===s.orderby&&(s._orderbyRandom=!0);if(!s.orderby||/^menu_order(?: ID)?$/i.test(s.orderby))o.orderby="menuOrder";if(s.ids){o.post__in=s.ids.split(",");o.orderby="post__in"}else s.include&&(o.post__in=s.include.split(","));s.exclude&&(o.post__not_in=s.exclude.split(","));o.post__in||(o.uploadedTo=s.id);a=t.omit(s,"id","ids","include","exclude","orderby","order");t.each(this.defaults,function(e,t){a[t]=f.coerce(a,t)});u=wp.media.query(o);u[this.tag]=new Backbone.Model(a);return u},shortcode:function(e){var r=e.props.toJSON(),i=t.pick(r,"orderby","order"),s,o,u=this;if(e.type){i.type=e.type;delete e.type}e[this.tag]&&t.extend(i,e[this.tag].toJSON());i.ids=e.pluck("id");r.uploadedTo&&(i.id=r.uploadedTo);delete i.orderby;i._orderbyRandom?i.orderby="rand":i._orderByField&&i._orderByField!="rand"&&(i.orderby=i._orderByField);delete i._orderbyRandom;delete i._orderByField;i.ids&&"post__in"===i.orderby&&delete i.orderby;t.each(this.defaults,function(e,t){i[t]=u.coerce(i,t);e===i[t]&&delete i[t]});s=new wp.shortcode({tag:this.tag,attrs:i,type:"single"});o=new wp.media.model.Attachments(e.models,{props:r});o[this.tag]=e[this.tag];n[s.string()]=o;return s},edit:function(e){var n=wp.shortcode.next(this.tag,e),r=this.defaults.id,i,s,o;if(!n||n.content!==e)return;n=n.shortcode;t.isUndefined(n.get("id"))&&!t.isUndefined(r)&&n.set("id",r);i=this.attachments(n);s=new wp.media.model.Selection(i.models,{props:i.props.toJSON(),multiple:!0});s[this.tag]=i[this.tag];s.more().done(function(){s.props.set({query:!1});s.unmirror();s.props.unset("orderby")});this.frame&&this.frame.dispose();n.attrs.named.type&&"video"===n.attrs.named.type?o="video-"+this.tag+"-edit":o=this.tag+"-edit";this.frame=wp.media({frame:"post",state:o,title:this.editTitle,editing:!0,multiple:!0,selection:s}).open();return this.frame}})};wp.media.gallery=new wp.media.collection({tag:"gallery",type:"image",editTitle:wp.media.view.l10n.editGalleryTitle,defaults:{itemtag:"dl",icontag:"dt",captiontag:"dd",columns:"3",link:"post",size:"thumbnail",order:"ASC",id:wp.media.view.settings.post&&wp.media.view.settings.post.id,orderby:"menu_order ID"}});wp.media.featuredImage={get:function(){return wp.media.view.settings.post.featuredImageId},set:function(t){var n=wp.media.view.settings;n.post.featuredImageId=t;wp.media.post("set-post-thumbnail",{json:!0,post_id:n.post.id,thumbnail_id:n.post.featuredImageId,_wpnonce:n.post.nonce}).done(function(t){e(".inside","#postimagediv").html(t)})},frame:function(){if(this._frame)return this._frame;this._frame=wp.media({state:"featured-image",states:[new wp.media.controller.FeaturedImage,new wp.media.controller.EditImage]});this._frame.on("toolbar:create:featured-image",function(e){this.createSelectToolbar(e,{text:wp.media.view.l10n.setFeaturedImage})},this._frame);this._frame.on("content:render:edit-image",function(){var e=this.state("featured-image").get("selection"),t=(new wp.media.view.EditImage({model:e.single(),controller:this})).render();this.content.set(t);t.loadEditor()},this._frame);this._frame.state("featured-image").on("select",this.select);return this._frame},select:function(){var e=this.get("selection").single();if(!wp.media.view.settings.post.featuredImageId)return;wp.media.featuredImage.set(e?e.id:-1)},init:function(){e("#postimagediv").on("click","#set-post-thumbnail",function(e){e.preventDefault();e.stopPropagation();wp.media.featuredImage.frame().open()}).on("click","#remove-post-thumbnail",function(){wp.media.view.settings.post.featuredImageId=-1})}};e(wp.media.featuredImage.init);wp.media.editor={insert:function(e){var n,r=!t.isUndefined(window.tinymce),i=!t.isUndefined(window.QTags),s=window.wpActiveEditor;if(window.send_to_editor)return window.send_to_editor.apply(this,arguments);if(!s){if(r&&tinymce.activeEditor){n=tinymce.activeEditor;s=window.wpActiveEditor=n.id}else if(!i)return!1}else r&&(n=tinymce.get(s));n&&!n.isHidden()?n.execCommand("mceInsertContent",!1,e):i?QTags.insertContent(e):document.getElementById(s).value+=e;if(window.tb_remove)try{window.tb_remove()}catch(o){}},add:function(r,i){var s=this.get(r);if(s)return s;s=n[r]=wp.media(t.defaults(i||{},{frame:"post",state:"insert",title:wp.media.view.l10n.addMedia,multiple:!0}));s.on("insert",function(n){var r=s.state();n=n||r.get("selection");if(!n)return;e.when.apply(e,n.map(function(e){var t=r.display(e).toJSON();return this.send.attachment(t,e.toJSON())},this)).done(function(){wp.media.editor.insert(t.toArray(arguments).join("\n\n"))})},this);s.state("gallery-edit").on("update",function(e){this.insert(wp.media.gallery.shortcode(e).string())},this);s.state("playlist-edit").on("update",function(e){this.insert(wp.media.playlist.shortcode(e).string())},this);s.state("video-playlist-edit").on("update",function(e){this.insert(wp.media.playlist.shortcode(e).string())},this);s.state("embed").on("select",function(){var e=s.state(),n=e.get("type"),r=e.props.toJSON();r.url=r.url||"";if("link"===n){t.defaults(r,{title:r.url,linkUrl:r.url});this.send.link(r).done(function(e){wp.media.editor.insert(e)})}else if("image"===n){t.defaults(r,{title:r.url,linkUrl:"",align:"none",link:"none"});"none"===r.link?r.linkUrl="":"file"===r.link&&(r.linkUrl=r.url);this.insert(wp.media.string.image(r))}},this);s.state("featured-image").on("select",wp.media.featuredImage.select);s.setState(s.options.state);return s},id:function(e){if(e)return e;e=wpActiveEditor;!e&&!t.isUndefined(window.tinymce)&&tinymce.activeEditor&&(e=tinymce.activeEditor.id);e=e||"";return e},get:function(e){e=this.id(e);return n[e]},remove:function(e){e=this.id(e);delete n[e]},send:{attachment:function(e,n){var r=n.caption,i,s;wp.media.view.settings.captions||delete n.caption;e=wp.media.string.props(e,n);i={id:n.id,post_content:n.description,post_excerpt:r};e.linkUrl&&(i.url=e.linkUrl);if("image"===n.type){s=wp.media.string.image(e);t.each({align:"align",size:"image-size",alt:"image_alt"},function(t,n){e[n]&&(i[t]=e[n])})}else if("video"===n.type)s=wp.media.string.video(e,n);else if("audio"===n.type)s=wp.media.string.audio(e,n);else{s=wp.media.string.link(e);i.post_title=e.title}return wp.media.post("send-attachment-to-editor",{nonce:wp.media.view.settings.nonce.sendToEditor,attachment:i,html:s,post_id:wp.media.view.settings.post.id})},link:function(e){return wp.media.post("send-link-to-editor",{nonce:wp.media.view.settings.nonce.sendToEditor,src:e.linkUrl,title:e.title,html:wp.media.string.link(e),post_id:wp.media.view.settings.post.id})}},open:function(e,t){var n;t=t||{};e=this.id(e);n=this.get(e);if(!n||n.options&&t.state!==n.options.state)n=this.add(e,t);return n.open()},init:function(){e(document.body).on("click",".insert-media",function(t){var n=e(t.currentTarget),r=n.data("editor"),i={frame:"post",state:"insert",title:wp.media.view.l10n.addMedia,multiple:!0};t.preventDefault();n.blur();if(n.hasClass("gallery")){i.state="gallery";i.title=wp.media.view.l10n.createGalleryTitle}wp.media.editor.open(r,i)});(new wp.media.view.EditorUploader).render()}};t.bindAll(wp.media.editor,"open");e(wp.media.editor.init)})(jQuery,_);