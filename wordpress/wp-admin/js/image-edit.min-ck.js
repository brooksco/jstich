!function(e){var t=window.imageEdit={iasapi:{},hold:{},postid:"",_view:!1,intval:function(e){return 0|e},setDisabled:function(t,n){n?(t.removeClass("disabled"),e("input",t).removeAttr("disabled")):(t.addClass("disabled"),e("input",t).prop("disabled",!0))},init:function(t){var n=this,r=e("#image-editor-"+n.postid),i=n.intval(e("#imgedit-x-"+t).val()),s=n.intval(e("#imgedit-y-"+t).val());n.postid!==t&&r.length&&n.close(n.postid),n.hold.w=n.hold.ow=i,n.hold.h=n.hold.oh=s,n.hold.xy_ratio=i/s,n.hold.sizer=parseFloat(e("#imgedit-sizer-"+t).val()),n.postid=t,e("#imgedit-response-"+t).empty(),e('input[type="text"]',"#imgedit-panel-"+t).keypress(function(t){var n=t.keyCode;return n>36&&41>n&&e(this).blur(),13===n?(t.preventDefault(),t.stopPropagation(),!1):void 0})},toggleEditor:function(t,n){var r=e("#imgedit-wait-"+t);n?r.height(e("#imgedit-panel-"+t).height()).fadeIn("fast"):r.fadeOut("fast")},toggleHelp:function(t){return e(t).parents(".imgedit-group-top").toggleClass("imgedit-help-toggled").find(".imgedit-help").slideToggle("fast"),!1},getTarget:function(t){return e('input[name="imgedit-target-'+t+'"]:checked',"#imgedit-save-target-"+t).val()||"full"},scaleChanged:function(t,n){var r=e("#imgedit-scale-width-"+t),i=e("#imgedit-scale-height-"+t),s=e("#imgedit-scale-warn-"+t),o="",u="";n?(u=""!==r.val()?Math.round(r.val()/this.hold.xy_ratio):"",i.val(u)):(o=""!==i.val()?Math.round(i.val()*this.hold.xy_ratio):"",r.val(o)),u&&u>this.hold.oh||o&&o>this.hold.ow?s.css("visibility","visible"):s.css("visibility","hidden")},getSelRatio:function(t){var n=this.hold.w,r=this.hold.h,i=this.intval(e("#imgedit-crop-width-"+t).val()),s=this.intval(e("#imgedit-crop-height-"+t).val());return i&&s?i+":"+s:n&&r?n+":"+r:"1:1"},filterHistory:function(t,n){var r,i,s,o,u=e("#imgedit-history-"+t).val(),f=[];if(""!==u){if(u=JSON.parse(u),r=this.intval(e("#imgedit-undone-"+t).val()),r>0)for(;r>0;)u.pop(),r--;if(n){if(!u.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";s=u[u.length-1],s=s.c||s.r||s.f||!1,s&&(this.hold.w=s.fw,this.hold.h=s.fh)}for(i in u)o=u[i],o.hasOwnProperty("c")?f[i]={c:{x:o.c.x,y:o.c.y,w:o.c.w,h:o.c.h}}:o.hasOwnProperty("r")?f[i]={r:o.r.r}:o.hasOwnProperty("f")&&(f[i]={f:o.f.f});return JSON.stringify(f)}return""},refreshEditor:function(n,r,i){var s,o,u=this;u.toggleEditor(n,1),s={action:"imgedit-preview",_ajax_nonce:r,postid:n,history:u.filterHistory(n,1),rand:u.intval(1e6*Math.random())},o=e('<img id="image-preview-'+n+'" />').on("load",function(){var r,s,u=e("#imgedit-crop-"+n),f=t;u.empty().append(o),r=Math.max(f.hold.w,f.hold.h),s=Math.max(e(o).width(),e(o).height()),f.hold.sizer=r>s?s/r:1,f.initCrop(n,o,u),f.setCropSelection(n,0),"undefined"!=typeof i&&null!==i&&i(),e("#imgedit-history-"+n).val()&&"0"===e("#imgedit-undone-"+n).val()?e("input.imgedit-submit-btn","#imgedit-panel-"+n).removeAttr("disabled"):e("input.imgedit-submit-btn","#imgedit-panel-"+n).prop("disabled",!0),f.toggleEditor(n,0)}).on("error",function(){e("#imgedit-crop-"+n).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>"),u.toggleEditor(n,0)}).attr("src",ajaxurl+"?"+e.param(s))},action:function(t,n,r){var i,s,o,u,f,l=this;if(l.notsaved(t))return!1;if(i={action:"image-editor",_ajax_nonce:n,postid:t},"scale"===r){if(s=e("#imgedit-scale-width-"+t),o=e("#imgedit-scale-height-"+t),u=l.intval(s.val()),f=l.intval(o.val()),1>u)return s.focus(),!1;if(1>f)return o.focus(),!1;if(u===l.hold.ow||f===l.hold.oh)return!1;i["do"]="scale",i.fwidth=u,i.fheight=f}else{if("restore"!==r)return!1;i["do"]="restore"}l.toggleEditor(t,1),e.post(ajaxurl,i,function(n){e("#image-editor-"+t).empty().append(n),l.toggleEditor(t,0),l._view&&l._view.refresh()})},save:function(n,r){var i,s=this.getTarget(n),o=this.filterHistory(n,0),u=this;return""===o?!1:(this.toggleEditor(n,1),i={action:"image-editor",_ajax_nonce:r,postid:n,history:o,target:s,context:e("#image-edit-context").length?e("#image-edit-context").val():null,"do":"save"},void e.post(ajaxurl,i,function(r){var i=JSON.parse(r);return i.error?(e("#imgedit-response-"+n).html('<div class="error"><p>'+i.error+"</p><div>"),void t.close(n)):(i.fw&&i.fh&&e("#media-dims-"+n).html(i.fw+" &times; "+i.fh),i.thumbnail&&e(".thumbnail","#thumbnail-head-"+n).attr("src",""+i.thumbnail),i.msg&&e("#imgedit-response-"+n).html('<div class="updated"><p>'+i.msg+"</p></div>"),void (u._view?u._view.save():t.close(n)))}))},open:function(t,n,r){this._view=r;var i,s=e("#image-editor-"+t),o=e("#media-head-"+t),u=e("#imgedit-open-btn-"+t),f=u.siblings(".spinner");u.prop("disabled",!0),f.show(),i={action:"image-editor",_ajax_nonce:n,postid:t,"do":"open"},s.load(ajaxurl,i,function(){s.fadeIn("fast"),o.fadeOut("fast",function(){u.removeAttr("disabled"),f.hide()})})},imgLoaded:function(t){var n=e("#image-preview-"+t),r=e("#imgedit-crop-"+t);this.initCrop(t,n,r),this.setCropSelection(t,0),this.toggleEditor(t,0)},initCrop:function(n,r,i){var s,o=this,u=e("#imgedit-sel-width-"+n),f=e("#imgedit-sel-height-"+n);o.iasapi=e(r).imgAreaSelect({parent:i,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(t){s=e(t),s.next().css("position","absolute").nextAll(".imgareaselect-outer").css("position","absolute"),i.children().mousedown(function(e){var t,r,i=!1;e.shiftKey&&(t=o.iasapi.getSelection(),r=o.getSelRatio(n),i=t&&t.width&&t.height?t.width+":"+t.height:r),o.iasapi.setOptions({aspectRatio:i})})},onSelectStart:function(){t.setDisabled(e("#imgedit-crop-sel-"+n),1)},onSelectEnd:function(e,r){t.setCropSelection(n,r)},onSelectChange:function(e,n){var r=t.hold.sizer;u.val(t.round(n.width/r)),f.val(t.round(n.height/r))}})},setCropSelection:function(t,n){var r,i=e("#imgedit-minthumb-"+t).val()||"128:128",s=this.hold.sizer;return i=i.split(":"),n=n||0,!n||n.width<3&&n.height<3?(this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),0),this.setDisabled(e("#imgedit-crop-sel-"+t),0),e("#imgedit-sel-width-"+t).val(""),e("#imgedit-sel-height-"+t).val(""),e("#imgedit-selection-"+t).val(""),!1):n.width<i[0]*s&&n.height<i[1]*s?(this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),0),e("#imgedit-selection-"+t).val(""),!1):(r={x:n.x1,y:n.y1,w:n.width,h:n.height},this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),1),void e("#imgedit-selection-"+t).val(JSON.stringify(r)))},close:function(t,n){return n=n||!1,n&&this.notsaved(t)?!1:(this.iasapi={},this.hold={},void (this._view?this._view.back():e("#image-editor-"+t).fadeOut("fast",function(){e("#media-head-"+t).fadeIn("fast"),e(this).empty()})))},notsaved:function(t){var n=e("#imgedit-history-"+t).val(),r=""!==n?JSON.parse(n):[],i=this.intval(e("#imgedit-undone-"+t).val());return i<r.length?confirm(e("#imgedit-leaving-"+t).html())?!1:!0:!1},addStep:function(t,n,r){for(var i=this,s=e("#imgedit-history-"+n),o=""!==s.val()?JSON.parse(s.val()):[],u=e("#imgedit-undone-"+n),f=i.intval(u.val());f>0;)o.pop(),f--;u.val(0),o.push(t),s.val(JSON.stringify(o)),i.refreshEditor(n,r,function(){i.setDisabled(e("#image-undo-"+n),!0),i.setDisabled(e("#image-redo-"+n),!1)})},rotate:function(t,n,r,i){return e(i).hasClass("disabled")?!1:void this.addStep({r:{r:t,fw:this.hold.h,fh:this.hold.w}},n,r)},flip:function(t,n,r,i){return e(i).hasClass("disabled")?!1:void this.addStep({f:{f:t,fw:this.hold.w,fh:this.hold.h}},n,r)},crop:function(t,n,r){var i=e("#imgedit-selection-"+t).val(),s=this.intval(e("#imgedit-sel-width-"+t).val()),o=this.intval(e("#imgedit-sel-height-"+t).val());return e(r).hasClass("disabled")||""===i?!1:(i=JSON.parse(i),void (i.w>0&&i.h>0&&s>0&&o>0&&(i.fw=s,i.fh=o,this.addStep({c:i},t,n))))},undo:function(t,n){var r=this,i=e("#image-undo-"+t),s=e("#imgedit-undone-"+t),o=r.intval(s.val())+1;i.hasClass("disabled")||(s.val(o),r.refreshEditor(t,n,function(){var n=e("#imgedit-history-"+t),s=""!==n.val()?JSON.parse(n.val()):[];r.setDisabled(e("#image-redo-"+t),!0),r.setDisabled(i,o<s.length)}))},redo:function(t,n){var r=this,i=e("#image-redo-"+t),s=e("#imgedit-undone-"+t),o=r.intval(s.val())-1;i.hasClass("disabled")||(s.val(o),r.refreshEditor(t,n,function(){r.setDisabled(e("#image-undo-"+t),!0),r.setDisabled(i,o>0)}))},setNumSelection:function(t){var n,r,i,s,o,u=e("#imgedit-sel-width-"+t),f=e("#imgedit-sel-height-"+t),l=this.intval(u.val()),c=this.intval(f.val()),h=e("#image-preview-"+t),p=h.height(),d=h.width(),v=this.hold.sizer,m=this.iasapi;return 1>l?(u.val(""),!1):1>c?(f.val(""),!1):void (l&&c&&(n=m.getSelection())&&(s=n.x1+Math.round(l*v),o=n.y1+Math.round(c*v),r=n.x1,i=n.y1,s>d&&(r=0,s=d,u.val(Math.round(s/v))),o>p&&(i=0,o=p,f.val(Math.round(o/v))),m.setSelection(r,i,s,o),m.update(),this.setCropSelection(t,m.getSelection())))},round:function(e){var t;return e=Math.round(e),this.hold.sizer>.6?e:(t=e.toString().slice(-1),"1"===t?e-1:"9"===t?e+1:e)},setRatioSelection:function(t,n,r){var i,s,o=this.intval(e("#imgedit-crop-width-"+t).val()),u=this.intval(e("#imgedit-crop-height-"+t).val()),f=e("#image-preview-"+t).height();return this.intval(e(r).val())?void (o&&u&&(this.iasapi.setOptions({aspectRatio:o+":"+u}),(i=this.iasapi.getSelection(!0))&&(s=Math.ceil(i.y1+(i.x2-i.x1)/(o/u)),s>f&&(s=f,n?e("#imgedit-crop-height-"+t).val(""):e("#imgedit-crop-width-"+t).val("")),this.iasapi.setSelection(i.x1,i.y1,i.x2,s),this.iasapi.update()))):void e(r).val("")}}}(jQuery);