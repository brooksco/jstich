/* global deleteUserSetting, setUserSetting, switchEditors, tinymce, tinyMCEPreInit *//**
 * Distraction Free Writing
 * (wp-fullscreen)
 *
 * Access the API globally using the window.wp.editor.fullscreen variable.
 */(function(e,t){function h(){l.removeClass("wp-dfw-show-ui")}function p(t){i.$dfwWrap.parents().each(function(n,r){var i,s=e(r);if(t){r.style.position&&s.data("wp-dfw-css-position",r.style.position);s.css("position","static")}else{i=s.data("wp-dfw-css-position");i=i||"";s.css("position",i)}if(r.nodeName==="BODY")return!1})}var n,r,i,s,o,u,a=0,f="transitionend webkitTransitionEnd",l=e(document.body),c=e(document);u=function(){this.topics={};this.subscribe=function(e,t){this.topics[e]||(this.topics[e]=[]);this.topics[e].push(t);return t};this.unsubscribe=function(e,t){var n,r,i=this.topics[e];if(!i)return t||[];if(t){for(n=0,r=i.length;n<r;n++)t==i[n]&&i.splice(n,1);return t}this.topics[e]=[];return i};this.publish=function(e,t){var n,r,i,s=this.topics[e];if(!s)return;t=t||[];for(n=0,r=s.length;n<r;n++)i=s[n].apply(null,t)===!1||i;return!i}};n={};r=n.pubsub=new u;i=n.settings={visible:!1,mode:"tinymce",id:"",title_id:"",timer:0,toolbar_shown:!1};s=n.toggleUI=function(e){clearTimeout(o);!l.hasClass("wp-dfw-show-ui")||e==="show"?l.addClass("wp-dfw-show-ui"):e!=="autohide"&&l.removeClass("wp-dfw-show-ui");e==="autohide"&&(o=setTimeout(h,2e3))};n.on=function(){var r,s,o;if(i.visible)return;i.$fullscreenFader||n.ui.init();typeof t.wp_fullscreen_settings=="object"&&e.extend(i,t.wp_fullscreen_settings);r=i.id||t.wpActiveEditor;if(!r){if(!i.hasTinymce)return;r=tinymce.activeEditor.id}i.id=r;s=i.$dfwWrap=e("#wp-"+r+"-wrap");if(!s.length)return;i.$dfwTextarea=e("#"+r);i.$editorContainer=s.find(".wp-editor-container");a=c.scrollTop();i.hasTinymce&&(i.editor=tinymce.get(r));if(i.editor&&!i.editor.isHidden()){i.origHeight=e("#"+r+"_ifr").height();i.mode="tinymce"}else{i.origHeight=i.$dfwTextarea.height();i.mode="html"}typeof t.adminpage=="undefined"||t.adminpage!=="post-php"&&t.adminpage!=="post-new-php"?o=r+"-title":o="title";i.$dfwTitle=e("#"+o);i.$dfwTitle.length||(i.$dfwTitle=null);n.ui.fade("show","showing","shown")};n.off=function(){if(!i.visible)return;n.ui.fade("hide","hiding","hidden")};n.switchmode=function(e){var t=i.mode;if(!e||!i.visible||!i.hasTinymce||typeof switchEditors=="undefined")return t;if(t==e)return t;if(e==="tinymce"&&!i.editor){i.editor=tinymce.get(i.id);!i.editor&&typeof tinyMCEPreInit!="undefined"&&tinyMCEPreInit.mceInit&&tinyMCEPreInit.mceInit[i.id]&&(tinyMCEPreInit.mceInit[i.id].wp_fullscreen=!0)}i.mode=e;switchEditors.go(i.id,e);n.refreshButtons(!0);e==="html"&&setTimeout(n.resizeTextarea,200);return e};n.save=function(){var n=e("#hiddenaction"),r=n.val(),s=e("#wp-fullscreen-save .spinner"),o=e("#wp-fullscreen-save .wp-fullscreen-saved-message"),u=e("#wp-fullscreen-save .wp-fullscreen-error-message");s.show();u.hide();o.hide();n.val("wp-fullscreen-save-post");i.editor&&!i.editor.isHidden()&&i.editor.save();e.ajax({url:t.ajaxurl,type:"post",data:e("form#post").serialize(),dataType:"json"}).done(function(t){s.hide();if(t&&t.success){o.show();setTimeout(function(){o.fadeOut(300)},3e3);t.data&&t.data.last_edited&&e("#wp-fullscreen-save input").attr("title",t.data.last_edited)}else u.show()}).fail(function(){s.hide();u.show()});n.val(r)};n.dfwWidth=function(t,n){var r;if(t&&t.toString().indexOf("%")!==-1){i.$editorContainer.css("width",t);i.$statusbar.css("width",t);i.$dfwTitle&&i.$dfwTitle.css("width",t);return}if(!t){r=e("#wp-fullscreen-body").data("theme-width")||800;i.$editorContainer.width(r);i.$statusbar.width(r);i.$dfwTitle&&i.$dfwTitle.width(r-16);deleteUserSetting("dfw_width");return}if(n)r=t;else{r=i.$editorContainer.width();r+=t}if(r<200||r>1200)return;i.$editorContainer.width(r);i.$statusbar.width(r);i.$dfwTitle&&i.$dfwTitle.width(r-16);setUserSetting("dfw_width",r)};r.subscribe("show",function(){var t=e("#last-edit").text();t&&e("#wp-fullscreen-save input").attr("title",t)});r.subscribe("showing",function(){l.addClass("wp-fullscreen-active");i.$dfwWrap.addClass("wp-fullscreen-wrap");if(i.$dfwTitle){i.$dfwTitle.after('<span id="wp-fullscreen-title-placeholder">');i.$dfwWrap.prepend(i.$dfwTitle.addClass("wp-fullscreen-title"))}n.refreshButtons();p(!0);e("#wpadminbar").hide();s("autohide");n.bind_resize();i.editor&&i.editor.execCommand("wpFullScreenOn");"ontouchstart"in t?n.dfwWidth("90%"):n.dfwWidth(e("#wp-fullscreen-body").data("dfw-width")||800,!0);scrollTo(0,0)});r.subscribe("shown",function(){i.visible=!0;i.editor&&!i.editor.isHidden()?i.editor.execCommand("wpAutoResize"):n.resizeTextarea("force")});r.subscribe("hide",function(){c.unbind(".fullscreen");i.$dfwTextarea.unbind(".wp-dfw-resize")});r.subscribe("hiding",function(){l.removeClass("wp-fullscreen-active");i.$dfwTitle&&e("#wp-fullscreen-title-placeholder").before(i.$dfwTitle.removeClass("wp-fullscreen-title").css("width","")).remove();i.$dfwWrap.removeClass("wp-fullscreen-wrap");i.$editorContainer.css("width","");i.$dfwTextarea.add("#"+i.id+"_ifr").height(i.origHeight);i.editor&&i.editor.execCommand("wpFullScreenOff");p(!1);t.scrollTo(0,a);e("#wpadminbar").show()});r.subscribe("hidden",function(){i.visible=!1});n.refreshButtons=function(t){if(i.mode==="html"){e("#wp-fullscreen-mode-bar").removeClass("wp-tmce-mode").addClass("wp-html-mode").find("a").removeClass("active").filter(".wp-fullscreen-mode-html").addClass("active");t?e("#wp-fullscreen-button-bar").fadeOut(150,function(){e(this).addClass("wp-html-mode").fadeIn(150)}):e("#wp-fullscreen-button-bar").addClass("wp-html-mode")}else if(i.mode==="tinymce"){e("#wp-fullscreen-mode-bar").removeClass("wp-html-mode").addClass("wp-tmce-mode").find("a").removeClass("active").filter(".wp-fullscreen-mode-tinymce").addClass("active");t?e("#wp-fullscreen-button-bar").fadeOut(150,function(){e(this).removeClass("wp-html-mode").fadeIn(150)}):e("#wp-fullscreen-button-bar").removeClass("wp-html-mode")}};n.ui={init:function(){var r;i.toolbar=r=e("#fullscreen-topbar");i.$fullscreenFader=e("#fullscreen-fader");i.$statusbar=e("#wp-fullscreen-status");i.hasTinymce=typeof tinymce!="undefined";i.hasTinymce||e("#wp-fullscreen-mode-bar").hide();c.keyup(function(e){var t=e.keyCode||e.charCode,r;if(!i.visible)return;navigator.platform&&navigator.platform.indexOf("Mac")!==-1?r=e.ctrlKey:r=e.altKey;if(r&&(61===t||107===t||187===t)){n.dfwWidth(25);e.preventDefault()}if(r&&(45===t||109===t||189===t)){n.dfwWidth(-25);e.preventDefault()}if(r&&48===t){n.dfwWidth(0);e.preventDefault()}});c.on("keydown.wp-fullscreen",function(e){if(27===e.which&&i.visible){n.off();e.stopImmediatePropagation()}});"ontouchstart"in t&&l.addClass("wp-dfw-touch");r.on("mouseenter",function(){s("show")}).on("mouseleave",function(){s("autohide")});e("#wp-fullscreen-buttons").on("click.wp-fullscreen","button",function(e){var n=e.currentTarget.id?e.currentTarget.id.substr(6):null;if(i.editor&&"tinymce"===i.mode)switch(n){case"bold":i.editor.execCommand("Bold");break;case"italic":i.editor.execCommand("Italic");break;case"bullist":i.editor.execCommand("InsertUnorderedList");break;case"numlist":i.editor.execCommand("InsertOrderedList");break;case"link":i.editor.execCommand("WP_Link");break;case"unlink":i.editor.execCommand("unlink");break;case"help":i.editor.execCommand("WP_Help");break;case"blockquote":i.editor.execCommand("mceBlockQuote")}else n==="link"&&t.wpLink&&t.wpLink.open();n==="wp-media-library"&&typeof wp!="undefined"&&wp.media&&wp.media.editor&&wp.media.editor.open(i.id)})},fade:function(e,t,s){i.$fullscreenFader||n.ui.init();if(e&&!r.publish(e))return;n.fade.In(i.$fullscreenFader,200,function(){t&&r.publish(t);n.fade.Out(i.$fullscreenFader,200,function(){s&&r.publish(s)})})}};n.fade={sensitivity:100,In:function(t,r,i,s){i=i||e.noop;r=r||400;s=s||!1;if(n.fade.transitions){if(t.is(":visible")){t.addClass("fade-trigger");return t}t.show();t.first().one(f,function(){i()});setTimeout(function(){t.addClass("fade-trigger")},this.sensitivity)}else{s&&t.stop();t.css("opacity",1);t.first().fadeIn(r,i);t.length>1&&t.not(":first").fadeIn(r)}return t},Out:function(t,r,i,s){i=i||e.noop;r=r||400;s=s||!1;if(!t.is(":visible"))return t;if(n.fade.transitions){t.first().one(f,function(){if(t.hasClass("fade-trigger"))return;t.hide();i()});setTimeout(function(){t.removeClass("fade-trigger")},this.sensitivity)}else{s&&t.stop();t.first().fadeOut(r,i);t.length>1&&t.not(":first").fadeOut(r)}return t},transitions:function(){var e=document.documentElement.style;return typeof e.WebkitTransition=="string"||typeof e.MozTransition=="string"||typeof e.OTransition=="string"||typeof e.transition=="string"}()};n.bind_resize=function(){i.$dfwTextarea.on("keydown.wp-dfw-resize click.wp-dfw-resize paste.wp-dfw-resize",function(){n.resizeTextarea()})};n.resizeTextarea=function(){var e=i.$dfwTextarea[0];e.scrollHeight>e.clientHeight&&(e.style.height=e.scrollHeight+50+"px")};t.wp=t.wp||{};t.wp.editor=t.wp.editor||{};t.wp.editor.fullscreen=n})(jQuery,window);