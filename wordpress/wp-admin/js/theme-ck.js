/* global _wpThemeSettings, confirm */window.wp=window.wp||{};(function(e){var t,n;t=wp.themes=wp.themes||{};t.data=_wpThemeSettings;n=t.data.l10n;t.isInstall=!!t.data.settings.isInstall;_.extend(t,{model:{},view:{},routes:{},router:{},template:wp.template});t.Model=Backbone.Model.extend({initialize:function(){var e;_.indexOf(t.data.installedThemes,this.get("slug"))!==-1&&this.set({installed:!0});this.set({id:this.get("slug")||this.get("id")});if(this.has("sections")){e=this.get("sections").description;this.set({description:e})}}});t.view.Appearance=wp.Backbone.View.extend({el:"#wpbody-content .wrap .theme-browser",window:e(window),page:0,initialize:function(e){_.bindAll(this,"scroller");this.SearchView=e.SearchView?e.SearchView:t.view.Search;this.window.bind("scroll",_.throttle(this.scroller,300))},render:function(){this.view=new t.view.Themes({collection:this.collection,parent:this});this.search();this.view.render();this.$el.empty().append(this.view.el).addClass("rendered");this.$el.append('<br class="clear"/>')},searchContainer:e("#wpbody h2:first"),search:function(){var r,i=this;if(t.data.themes.length===1)return;r=new this.SearchView({collection:i.collection,parent:this});r.render();this.searchContainer.append(e.parseHTML('<label class="screen-reader-text" for="theme-search-input">'+n.search+"</label>")).append(r.el)},scroller:function(){var e=this,t,n;t=this.window.scrollTop()+e.window.height();n=e.$el.offset().top+e.$el.outerHeight(!1)-e.window.height();n=Math.round(n*.9);t>n&&this.trigger("theme:scroll")}});t.Collection=Backbone.Collection.extend({model:t.Model,terms:"",doSearch:function(e){if(this.terms===e)return;this.terms=e;this.terms.length>0&&this.search(this.terms);this.terms===""&&this.reset(t.data.themes);this.trigger("update")},search:function(e){var n,r,i;this.reset(t.data.themes,{silent:!0});e=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");e=e.replace(/ /g,")(?=.*");n=new RegExp("^(?=.*"+e+").+","i");r=this.filter(function(t){i=_.union(t.get("name"),t.get("id"),t.get("description"),t.get("author"),t.get("tags"));n.test(t.get("author"))&&e.length>2&&t.set("displayAuthor",!0);return n.test(i)});this.reset(r)},paginate:function(e){var t=this;e=e||0;t=_(t.rest(20*e));t=_(t.first(20));return t},count:!1,query:function(t){var n=this.queries,r=this,i,s,o;this.currentQuery.request=t;i=_.find(n,function(e){return _.isEqual(e.request,t)});s=_.has(t,"page");s||(this.currentQuery.page=1);if(!i&&!s)i=this.apiCall(t).done(function(e){if(e.themes){r.reset(e.themes);o=e.info.results;n.push({themes:e.themes,request:t,total:o})}r.trigger("update");r.trigger("query:success",o);e.themes&&e.themes.length===0&&r.trigger("query:empty")}).fail(function(){r.trigger("query:fail")});else{if(s)return this.apiCall(t,s).done(function(e){r.add(e.themes);r.trigger("query:success");r.loadingThemes=!1}).fail(function(){r.trigger("query:fail")});i.themes.length===0?r.trigger("query:empty"):e("body").removeClass("no-results");_.isNumber(i.total)&&(this.count=i.total);this.reset(i.themes);i.total||(this.count=this.length);this.trigger("update");this.trigger("query:success",this.count)}},queries:[],currentQuery:{page:1,request:{}},apiCall:function(t,n){return wp.ajax.send("query-themes",{data:{request:_.extend({per_page:100,fields:{description:!0,tested:!0,requires:!0,rating:!0,downloaded:!0,downloadLink:!0,last_updated:!0,homepage:!0,num_ratings:!0}},t)},beforeSend:function(){n||e("body").addClass("loading-themes").removeClass("no-results")}})},loadingThemes:!1});t.view.Theme=wp.Backbone.View.extend({className:"theme",state:"grid",html:t.template("theme"),events:{click:t.isInstall?"preview":"expand","click .preview":"preview",keydown:t.isInstall?"preview":"expand",touchend:t.isInstall?"preview":"expand",keyup:"addFocus",touchmove:"preventExpand"},touchDrag:!1,render:function(){var e=this.model.toJSON();this.$el.html(this.html(e)).attr({tabindex:0,"aria-describedby":e.id+"-action "+e.id+"-name"});this.activeTheme();this.model.get("displayAuthor")&&this.$el.addClass("display-author");this.model.get("installed")&&this.$el.addClass("is-installed")},activeTheme:function(){this.model.get("active")&&this.$el.addClass("active")},addFocus:function(){var t=e(":focus").hasClass("theme")?e(":focus"):e(":focus").parents(".theme");e(".theme.focus").removeClass("focus");t.addClass("focus")},expand:function(n){var r=this;n=n||window.event;if(n.type==="keydown"&&n.which!==13&&n.which!==32)return;if(this.touchDrag===!0)return this.touchDrag=!1;if(e(n.target).is(".theme-actions a"))return;t.focusedTheme=this.$el;this.trigger("theme:expand",r.model.cid)},preventExpand:function(){this.touchDrag=!0},preview:function(n){var r=this,i,s;if(this.touchDrag===!0)return this.touchDrag=!1;if(e(n.target).hasClass("button-primary"))return;if(n.type==="keydown"&&n.which!==13&&n.which!==32)return;if(n.type==="keydown"&&n.which!==13&&e(":focus").hasClass("button"))return;n.preventDefault();n=n||window.event;t.focusedTheme=this.$el;s=new t.view.Preview({model:this.model});s.render();this.setNavButtonsState();this.model.collection.length===1?s.$el.addClass("no-navigation"):s.$el.removeClass("no-navigation");e("div.wrap").append(s.el);this.listenTo(s,"theme:next",function(){i=r.model;_.isUndefined(r.current)||(i=r.current);r.current=r.model.collection.at(r.model.collection.indexOf(i)+1);if(_.isUndefined(r.current)){r.options.parent.parent.trigger("theme:end");return r.current=i}s=new t.view.Preview({model:r.current});s.render();this.setNavButtonsState();e("div.wrap").append(s.el);e(".next-theme").focus()}).listenTo(s,"theme:previous",function(){i=r.model;if(r.model.collection.indexOf(r.current)===0)return;_.isUndefined(r.current)||(i=r.current);r.current=r.model.collection.at(r.model.collection.indexOf(i)-1);if(_.isUndefined(r.current))return;s=new t.view.Preview({model:r.current});s.render();this.setNavButtonsState();e("div.wrap").append(s.el);e(".previous-theme").focus()});this.listenTo(s,"preview:close",function(){r.current=r.model})},setNavButtonsState:function(){var t=e(".theme-install-overlay"),n=_.isUndefined(this.current)?this.model:this.current;0===this.model.collection.indexOf(n)&&t.find(".previous-theme").addClass("disabled");_.isUndefined(this.model.collection.at(this.model.collection.indexOf(n)+1))&&t.find(".next-theme").addClass("disabled")}});t.view.Details=wp.Backbone.View.extend({className:"theme-overlay",events:{click:"collapse","click .delete-theme":"deleteTheme","click .left":"previousTheme","click .right":"nextTheme"},html:t.template("theme-single"),render:function(){var e=this.model.toJSON();this.$el.html(this.html(e));this.activeTheme();this.navigation();this.screenshotCheck(this.$el);this.containFocus(this.$el)},activeTheme:function(){this.$el.toggleClass("active",this.model.get("active"))},containFocus:function(t){var n;_.delay(function(){e(".theme-wrap a.button-primary:visible").focus()},500);t.on("keydown.wp-themes",function(r){if(r.which===9){n=e(r.target);if(n.is("button.left")&&r.shiftKey){t.find(".theme-actions a:last-child").focus();r.preventDefault()}else if(n.is(".theme-actions a:last-child")){t.find("button.left").focus();r.preventDefault()}}})},collapse:function(n){var r=this,i;n=n||window.event;if(t.data.themes.length===1)return;if(e(n.target).is(".theme-backdrop")||e(n.target).is(".close")||n.keyCode===27){e("body").addClass("closing-overlay");this.$el.fadeOut(130,function(){e("body").removeClass("closing-overlay");r.closeOverlay();i=document.body.scrollTop;t.router.navigate(t.router.baseUrl(""));document.body.scrollTop=i;t.focusedTheme&&t.focusedTheme.focus()})}},navigation:function(){this.model.cid===this.model.collection.at(0).cid&&this.$el.find(".left").addClass("disabled");this.model.cid===this.model.collection.at(this.model.collection.length-1).cid&&this.$el.find(".right").addClass("disabled")},closeOverlay:function(){e("body").removeClass("theme-overlay-open");this.remove();this.unbind();this.trigger("theme:collapse")},deleteTheme:function(){return confirm(t.data.settings.confirmDelete)},nextTheme:function(){var e=this;e.trigger("theme:next",e.model.cid);return!1},previousTheme:function(){var e=this;e.trigger("theme:previous",e.model.cid);return!1},screenshotCheck:function(e){var t,n;t=e.find(".screenshot img");n=new Image;n.src=t.attr("src");n.width&&n.width<=300&&e.addClass("small-screenshot")}});t.view.Preview=t.view.Details.extend({className:"wp-full-overlay expanded",el:".theme-install-overlay",events:{"click .close-full-overlay":"close","click .collapse-sidebar":"collapse","click .previous-theme":"previousTheme","click .next-theme":"nextTheme",keyup:"keyEvent"},html:t.template("theme-preview"),render:function(){var n=this.model.toJSON();this.$el.html(this.html(n));t.router.navigate(t.router.baseUrl("?theme="+this.model.get("id")),{replace:!0});this.$el.fadeIn(200,function(){e("body").addClass("theme-installer-active full-overlay-active");e(".close-full-overlay").focus()})},close:function(){this.$el.fadeOut(200,function(){e("body").removeClass("theme-installer-active full-overlay-active");t.focusedTheme&&t.focusedTheme.focus()});t.router.navigate(t.router.baseUrl(""));this.trigger("preview:close");this.unbind();return!1},collapse:function(){this.$el.toggleClass("collapsed").toggleClass("expanded");return!1},keyEvent:function(e){if(e.keyCode===27){this.undelegateEvents();this.close()}e.keyCode===39&&_.once(this.nextTheme());e.keyCode===37&&this.previousTheme()}});t.view.Themes=wp.Backbone.View.extend({className:"themes",$overlay:e("div.theme-overlay"),index:0,count:e(".theme-count"),initialize:function(t){var n=this;this.parent=t.parent;this.setView("grid");n.currentTheme();this.listenTo(n.collection,"update",function(){n.parent.page=0;n.currentTheme();n.render(this)});this.listenTo(n.collection,"query:success",function(e){_.isNumber(e)?n.count.text(e):n.count.text(n.collection.length)});this.listenTo(n.collection,"query:empty",function(){e("body").addClass("no-results")});this.listenTo(this.parent,"theme:scroll",function(){n.renderThemes(n.parent.page)});this.listenTo(this.parent,"theme:close",function(){n.overlay&&n.overlay.closeOverlay()});e("body").on("keyup",function(e){if(!n.overlay)return;e.keyCode===39&&n.overlay.nextTheme();e.keyCode===37&&n.overlay.previousTheme();e.keyCode===27&&n.overlay.collapse(e)})},render:function(){this.$el.html("");if(t.data.themes.length===1){this.singleTheme=new t.view.Details({model:this.collection.models[0]});this.singleTheme.render();this.$el.addClass("single-theme");this.$el.append(this.singleTheme.el)}this.options.collection.size()>0&&this.renderThemes(this.parent.page);this.count.text(this.collection.count?this.collection.count:this.collection.length)},renderThemes:function(r){var i=this;i.instance=i.collection.paginate(r);if(i.instance.size()===0){this.parent.trigger("theme:end");return}r>=1&&e(".add-new-theme").remove();i.instance.each(function(e){i.theme=new t.view.Theme({model:e,parent:i});i.theme.render();i.$el.append(i.theme.el);i.listenTo(i.theme,"theme:expand",i.expand,i)});t.data.settings.canInstall&&this.$el.append('<div class="theme add-new-theme"><a href="'+t.data.settings.installURI+'"><div class="theme-screenshot"><span></span></div><h3 class="theme-name">'+n.addNew+"</h3></a></div>");this.parent.page++},currentTheme:function(){var e=this,t;t=e.collection.findWhere({active:!0});if(t){e.collection.remove(t);e.collection.add(t,{at:0})}},setView:function(e){return e},expand:function(n){var r=this;this.model=r.collection.get(n);t.router.navigate(t.router.baseUrl("?theme="+this.model.id));this.setView("detail");e("body").addClass("theme-overlay-open");this.overlay=new t.view.Details({model:r.model});this.overlay.render();this.$overlay.html(this.overlay.el);this.listenTo(this.overlay,"theme:next",function(){r.next([r.model.cid])}).listenTo(this.overlay,"theme:previous",function(){r.previous([r.model.cid])})},next:function(e){var t=this,n,r;n=t.collection.get(e[0]);r=t.collection.at(t.collection.indexOf(n)+1);if(r!==undefined){this.overlay.closeOverlay();t.theme.trigger("theme:expand",r.cid)}},previous:function(e){var t=this,n,r;n=t.collection.get(e[0]);r=t.collection.at(t.collection.indexOf(n)-1);if(r!==undefined){this.overlay.closeOverlay();t.theme.trigger("theme:expand",r.cid)}}});t.view.Search=wp.Backbone.View.extend({tagName:"input",className:"theme-search",id:"theme-search-input",searching:!1,attributes:{placeholder:n.searchPlaceholder,type:"search"},events:{input:"search",keyup:"search",change:"search",search:"search",blur:"pushState"},initialize:function(e){this.parent=e.parent;this.listenTo(this.parent,"theme:close",function(){this.searching=!1})},search:function(e){var n={};e.type==="keyup"&&e.which===27&&(e.target.value="");e.which===13&&this.$el.trigger("blur");this.collection.doSearch(e.target.value);this.searching&&e.which!==13?n.replace=!0:this.searching=!0;e.target.value?t.router.navigate(t.router.baseUrl("?search="+e.target.value),n):t.router.navigate(t.router.baseUrl(""))},pushState:function(e){var n=t.router.baseUrl("");e.target.value&&(n=t.router.baseUrl("?search="+e.target.value));this.searching=!1;t.router.navigate(n)}});t.Router=Backbone.Router.extend({routes:{"themes.php?theme=:slug":"theme","themes.php?search=:query":"search","themes.php?s=:query":"search","themes.php":"themes","":"themes"},baseUrl:function(e){return"themes.php"+e},search:function(t){e(".theme-search").val(t)},themes:function(){e(".theme-search").val("")},navigate:function(){Backbone.history._hasPushState&&Backbone.Router.prototype.navigate.apply(this,arguments)}});t.Run={init:function(){this.themes=new t.Collection(t.data.themes);this.view=new t.view.Appearance({collection:this.themes});this.render()},render:function(){this.view.render();this.routes();Backbone.history.start({root:t.data.settings.adminUrl,pushState:!0,hashChange:!1})},routes:function(){var n=this;t.router=new t.Router;t.router.on("route:theme",function(e){n.view.view.expand(e)});t.router.on("route:themes",function(){n.themes.doSearch("");n.view.trigger("theme:close")});t.router.on("route:search",function(){e(".theme-search").trigger("keyup")});this.extraRoutes()},extraRoutes:function(){return!1}};t.view.InstallerSearch=t.view.Search.extend({events:{keyup:"search"},search:function(e){if(e.type==="keyup"&&(e.which===9||e.which===16))return;this.collection=this.options.parent.view.collection;e.type==="keyup"&&e.which===27&&(e.target.value="");_.debounce(_.bind(this.doSearch,this),300)(e.target.value)},doSearch:_.debounce(function(n){var r={};r.search=n;if(n.substring(0,7)==="author:"){r.search="";r.author=n.slice(7)}if(n.substring(0,4)==="tag:"){r.search="";r.tag=[n.slice(4)]}e(".theme-section.current").removeClass("current");e("body").removeClass("more-filters-opened filters-applied");this.collection.query(r);t.router.navigate(t.router.baseUrl("?search="+n),{replace:!0})},300)});t.view.Installer=t.view.Appearance.extend({el:"#wpbody-content .wrap",events:{"click .theme-section":"onSort","click .theme-filter":"onFilter","click .more-filters":"moreFilters","click .apply-filters":"applyFilters",'click [type="checkbox"]':"addFilter","click .clear-filters":"clearFilters","click .feature-name":"filterSection","click .filtering-by a":"backToFilters"},render:function(){var r=this;this.search();this.uploader();this.collection=new t.Collection;this.listenTo(this,"theme:end",function(){if(r.collection.loadingThemes)return;r.collection.loadingThemes=!0;r.collection.currentQuery.page++;_.extend(r.collection.currentQuery.request,{page:r.collection.currentQuery.page});r.collection.query(r.collection.currentQuery.request)});this.listenTo(this.collection,"query:success",function(){e("body").removeClass("loading-themes");e(".theme-browser").find("div.error").remove()});this.listenTo(this.collection,"query:fail",function(){e("body").removeClass("loading-themes");e(".theme-browser").find("div.error").remove();e(".theme-browser").find("div.themes").before('<div class="error"><p>'+n.error+"</p></div>")});this.view&&this.view.remove();this.view=new t.view.Themes({collection:this.collection,parent:this});this.page=0;this.$el.find(".themes").remove();this.view.render();this.$el.find(".theme-browser").append(this.view.el).addClass("rendered")},browse:function(e){this.collection.query({browse:e})},onSort:function(n){var r=e(n.target),i=r.data("sort");n.preventDefault();e("body").removeClass("filters-applied more-filters-opened");if(r.hasClass(this.activeClass))return;this.sort(i);t.router.navigate(t.router.baseUrl("?browse="+i))},sort:function(t){this.clearSearch();e(".theme-section, .theme-filter").removeClass(this.activeClass);e('[data-sort="'+t+'"]').addClass(this.activeClass);this.browse(t)},onFilter:function(t){var n,r=e(t.target),i=r.data("filter");if(r.hasClass(this.activeClass))return;e(".theme-filter, .theme-section").removeClass(this.activeClass);r.addClass(this.activeClass);if(!i)return;i=_.union(i,this.filtersChecked());n={tag:[i]};this.collection.query(n)},addFilter:function(){this.filtersChecked()},applyFilters:function(t){var n,r=this.filtersChecked(),i={tag:r},s=e(".filtering-by .tags");t&&t.preventDefault();e("body").addClass("filters-applied");e(".theme-section.current").removeClass("current");s.empty();_.each(r,function(t){n=e('label[for="feature-id-'+t+'"]').text();s.append('<span class="tag">'+n+"</span>")});this.collection.query(i)},filtersChecked:function(){var t=e(".feature-group").find(":checkbox"),n=[];_.each(t.filter(":checked"),function(t){n.push(e(t).prop("value"))});if(n.length===0){e(".apply-filters").find("span").text("");e(".clear-filters").hide();e("body").removeClass("filters-applied");return!1}e(".apply-filters").find("span").text(n.length);e(".clear-filters").css("display","inline-block");return n},activeClass:"current",searchContainer:e(".theme-navigation"),uploader:function(){e("a.upload").on("click",function(n){n.preventDefault();e("body").addClass("show-upload-theme");t.router.navigate(t.router.baseUrl("?upload"),{replace:!0})});e("a.browse-themes").on("click",function(n){n.preventDefault();e("body").removeClass("show-upload-theme");t.router.navigate(t.router.baseUrl(""),{replace:!0})})},moreFilters:function(n){n.preventDefault();if(e("body").hasClass("filters-applied"))return this.backToFilters();if(e("body").hasClass("more-filters-opened")&&this.filtersChecked())return this.addFilter();this.clearSearch();t.router.navigate(t.router.baseUrl(""));e("body").toggleClass("more-filters-opened")},filterSection:function(){e(event.target).parent().toggleClass("open")},clearFilters:function(t){var n=e(".feature-group").find(":checkbox"),r=this;t.preventDefault();_.each(n.filter(":checked"),function(t){e(t).prop("checked",!1);return r.filtersChecked()})},backToFilters:function(t){t&&t.preventDefault();e("body").removeClass("filters-applied")},clearSearch:function(){e("#theme-search-input").val("")}});t.InstallerRouter=Backbone.Router.extend({routes:{"theme-install.php?theme=:slug":"preview","theme-install.php?browse=:sort":"sort","theme-install.php?upload":"upload","theme-install.php?search=:query":"search","theme-install.php":"sort"},baseUrl:function(e){return"theme-install.php"+e},search:function(t){e(".theme-search").val(t)},navigate:function(){Backbone.history._hasPushState&&Backbone.Router.prototype.navigate.apply(this,arguments)}});t.RunInstaller={init:function(){this.view=new t.view.Installer({section:"featured",SearchView:t.view.InstallerSearch});this.render()},render:function(){this.view.render();this.routes();Backbone.history.start({root:t.data.settings.adminUrl,pushState:!0,hashChange:!1})},routes:function(){var n=this,r={};t.router=new t.InstallerRouter;t.router.on("route:preview",function(e){r.theme=e;n.view.collection.query(r)});t.router.on("route:sort",function(e){e||(e="featured");n.view.sort(e);n.view.trigger("theme:close")});t.router.on("route:upload",function(){e("a.upload").trigger("click")});t.router.on("route:search",function(){e(".theme-search").focus().trigger("keyup")});this.extraRoutes()},extraRoutes:function(){return!1}};e(document).ready(function(){t.isInstall?t.RunInstaller.init():t.Run.init()})})(jQuery);var tb_position;jQuery(document).ready(function(e){tb_position=function(){var t=e("#TB_window"),n=e(window).width(),r=e(window).height(),i=1040<n?1040:n,s=0;e("#wpadminbar").length&&(s=parseInt(e("#wpadminbar").css("height"),10));if(t.size()){t.width(i-50).height(r-45-s);e("#TB_iframeContent").width(i-50).height(r-75-s);t.css({"margin-left":"-"+parseInt((i-50)/2,10)+"px"});typeof document.body.style.maxWidth!="undefined"&&t.css({top:20+s+"px","margin-top":"0"})}};e(window).resize(function(){tb_position()})});